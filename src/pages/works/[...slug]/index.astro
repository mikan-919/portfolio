---
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import Github from "simple-icons-astro/Github";
import Section from "@/components/ui/Section.astro";
import Layout from "@/layouts/Layout.astro";
export const prerender = true;
export async function getStaticPaths() {
    const works = await getCollection("works");
    return works.map((entry) => ({
        params: { slug: entry.id },
    }));
}

const { slug } = Astro.params;
const allWorks = await getCollection("works");
const entry = allWorks.find((entry) => entry.id === slug);
if (!entry) {
    return Astro.redirect("/404");
}
const { Content } = await render(entry);

// Sort by date (newest first)
const sortedWorks = allWorks.sort(
    (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);
const currentIndex = sortedWorks.findIndex((work) => work.id === entry.id);
const nextWork = sortedWorks[currentIndex + 1];
const prevWork = sortedWorks[currentIndex - 1];

const formattedDate = entry.data.publishDate.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
});
---

<Layout title={`Portfoliooo | ${entry.data.title}`}>
    <!-- Header Image & Title -->
    <Section
        transition:name={`work-header-${entry.id}`}
        class="relative h-96 md:h-128"
    >
        {
            entry.data.image ? (
                <Image
                    src={entry.data.image}
                    alt={entry.data.title}
                    class="w-full h-full object-cover"
                />
            ) : (
                <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                    <div class="opacity-20 bg-[radial-gradient(#000_1px,transparent_1px)] bg-size-[16px_16px] w-full h-full" />
                </div>
            )
        }
        <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px]">
            <div class="absolute bottom-0 left-0 w-full p-8 md:p-16 text-white">
                <div class="max-w-5xl space-y-4">
                    <div class="flex items-center gap-4">
                        <span
                            class="bg-white text-black px-3 py-1 text-xs font-bold uppercase tracking-wider"
                        >
                            {entry.data.category}
                        </span>
                        {
                            entry.data.isComingSoon && (
                                <span class="bg-yellow-400 text-black px-3 py-1 text-xs font-bold uppercase tracking-wider">
                                    Coming Soon
                                </span>
                            )
                        }
                    </div>
                    <h1
                        class="text-4xl md:text-7xl font-black leading-none tracking-tight"
                    >
                        {entry.data.title}
                    </h1>
                    <p class="font-mono text-sm md:text-base opacity-90">
                        PUBLISHED: {formattedDate}
                    </p>
                </div>
            </div>
        </div>
    </Section>

    <!-- Info Grid -->
    <div class="full-width-border">
        <div
            class="content-container grid grid-cols-1 md:grid-cols-4 divide-y md:divide-y-0 md:divide-x-2 divide-black"
        >
            <!-- Role -->
            <div class="p-8 flex flex-col gap-2">
                <h6 class="font-black font-mono text-sm uppercase opacity-50">
                    Role
                </h6>
                <p class="font-bold text-lg leading-tight">
                    {entry.data.role || "Creator"}
                </p>
            </div>

            <!-- Links -->
            <div class="p-8 flex flex-col gap-2">
                <h6 class="font-black font-mono text-sm uppercase opacity-50">
                    Links
                </h6>
                <div class="flex flex-col gap-1">
                    {
                        entry.data.link ? (
                            <a
                                href={entry.data.link}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="font-bold text-lg hover:underline decoration-2 underline-offset-2 flex items-center gap-2"
                            >
                                Visit Site
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="lucide lucide-external-link"
                                >
                                    <>
                                        <path d="M15 3h6v6" />
                                        <path d="M10 14 21 3" />
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                    </>
                                </svg>
                            </a>
                        ) : (
                            <span class="opacity-50 font-mono text-sm">-</span>
                        )
                    }
                    {
                        entry.data.github && (
                            <a
                                href={entry.data.github}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="font-bold text-lg hover:underline decoration-2 underline-offset-2 flex items-center gap-2"
                            >
                                GitHub
                                <Github />
                            </a>
                        )
                    }
                </div>
            </div>

            <!-- Tech Stack -->
            <div class="md:col-span-2 p-8 flex flex-col gap-2">
                <h6 class="font-black font-mono text-sm uppercase opacity-50">
                    Tech Stack
                </h6>
                <div class="flex flex-wrap gap-2">
                    {
                        entry.data.tags.map((tag) => (
                            <span class="border border-black px-2 py-1 text-xs font-bold uppercase bg-gray-50">
                                {tag}
                            </span>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="full-width-border">
        <div
            class="content-container grid grid-cols-1 lg:grid-cols-[3fr_1fr] min-h-[50vh]"
        >
            <div
                class="p-8 md:p-16 prose prose-neutral max-w-none
                prose-headings:font-black prose-headings:uppercase prose-headings:tracking-tight
                prose-h1:text-4xl prose-h2:text-3xl prose-h3:text-2xl
                prose-p:text-lg prose-p:leading-relaxed
                prose-a:text-black prose-a:font-bold prose-a:decoration-2 prose-a:underline-offset-2
                prose-img:border-2 prose-img:border-black prose-img:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]
                prose-blockquote:border-l-4 prose-blockquote:border-black prose-blockquote:bg-gray-100 prose-blockquote:py-4 prose-blockquote:px-6 prose-blockquote:not-italic prose-blockquote:font-medium"
            >
                <Content />
            </div>

            <!-- Sidebar / Gallery Placeholder -->
            <div
                class="border-t-2 lg:border-t-0 lg:border-l-2 border-black bg-gray-50 p-8"
            >
                {
                    entry.data.gallery && entry.data.gallery.length > 0 ? (
                        <div class="flex flex-col gap-4">
                            <h6 class="font-black font-mono text-sm uppercase opacity-50 mb-2">
                                Gallery
                            </h6>
                            {entry.data.gallery.map((img) => (
                                <Image
                                    src={img}
                                    alt=""
                                    class="w-full border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"
                                />
                            ))}
                        </div>
                    ) : (
                        <div class="h-full flex items-center justify-center opacity-20">
                            <div class="text-center">
                                <span class="block text-4xl mb-2">ðŸ“·</span>
                                <span class="font-mono text-sm">
                                    No Gallery Images
                                </span>
                            </div>
                        </div>
                    )
                }
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <Section isGrow class="grid grid-cols-[2fr_6fr_2fr]">
        {
            prevWork ? (
                <a
                    href={`/works/${prevWork.id}`}
                    class="group relative flex flex-col justify-center p-8 border-r-2 border-black "
                >
                    <span class="text-xs font-mono opacity-60 mb-2 group-hover:opacity-100">
                        &lt; NEWER
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight line-clamp-2">
                        {prevWork.data.title}
                    </span>
                    <span class="slide-bg-r bg-white mix-blend-difference" />
                </a>
            ) : (
                <div class="flex flex-col justify-center p-8 border-r-2 border-black select-none">
                    <span class="text-xs font-mono mb-2 opacity-25">
                        &lt; NEWER
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight opacity-25">
                        No newer posts
                    </span>
                </div>
            )
        }
        <div
            class="flex items-center justify-center border-r-2 border-black transition-colors group"
        >
            <a
                href="/blog"
                class="group relative font-black font-mono text-xl md:text-2xl tracking-widest w-full h-full flex items-center justify-center"
            >
                BACK TO BLOG
                <span class="slide-bg-t bg-white mix-blend-difference"></span>
            </a>
        </div>
        {
            nextWork ? (
                <a
                    href={`/works/${nextWork.id}`}
                    class="group relative flex flex-col justify-center items-end text-right p-8"
                >
                    <span class="text-xs font-mono opacity-60 mb-2 group-hover:opacity-100">
                        OLDER &gt;
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight line-clamp-2">
                        {nextWork.data.title}
                    </span>
                    <span class="slide-bg-l bg-white mix-blend-difference" />
                </a>
            ) : (
                <div class="flex flex-col justify-center items-end text-right p-8 select-none">
                    <span class="text-xs font-mono mb-2 opacity-25">
                        OLDER &gt;
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight opacity-25">
                        No older posts
                    </span>
                </div>
            )
        }
    </Section>
</Layout>
