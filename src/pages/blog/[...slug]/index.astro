---
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import TableOfContents from "@/components/blog/TableOfContents.astro";
import Section from "@/components/ui/Section.astro";
import Layout from "@/layouts/Layout.astro";

const { slug } = Astro.params;
const allPosts = await getCollection("articles");

// 2. 日付順にソート（新しい順）
const sortedPosts = allPosts.sort(
    (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);

// 3. 現在の記事のインデックス（何番目か）を探す
const currentIndex = sortedPosts.findIndex((post) => post.id === slug);

// 記事が見つからなければ404へ
if (currentIndex === -1) {
    throw new Error("Not Found");
}
const entry = sortedPosts[currentIndex];
const { Content, headings } = await render(entry);
const nextPost = sortedPosts[currentIndex + 1]; // 過去の記事へ
const prevPost = sortedPosts[currentIndex - 1]; // 新しい記事へ

const formattedDate = entry.data.publishDate.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
});
---

<Layout title={`Portfoliooo | ${entry.data.title}`}>
    <!-- Header Image & Title -->
    <div class="full-width-border" transition:name="blog-header">
        <div class="content-container relative h-128">
            {
                entry.data.image ? (
                    <Image
                        src={entry.data.image}
                        alt={entry.data.title}
                        class="w-full h-full object-cover"
                    />
                ) : (
                    <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                        <div class="opacity-20 bg-[radial-gradient(#000_1px,transparent_1px)] bg-size-[16px_16px] w-full h-full" />
                    </div>
                )
            }
            <div class="absolute inset-0 bg-black/30 backdrop-blur-[2px]">
                <div
                    class="absolute bottom-0 left-0 w-full p-8 md:p-16 md:pb-8 text-white"
                >
                    <div class="max-w-5xl space-y-2">
                        <h1
                            class="text-4xl md:text-6xl font-black leading-none"
                        >
                            {entry.data.title}
                        </h1>
                        <p class="font-mono text-xs md:text-sm opacity-90">
                            PUBLISHED ON {formattedDate}
                        </p>
                        <div class="pt-2">
                            <span
                                class="font-mono text-sm border-t-2 border-white inline-block pt-8 md:text-base opacity-90 w-full"
                            >
                                {entry.data.description}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="full-width-border">
        <div class="content-container grid grid-cols-[7fr_3fr]">
            <div class="flex gap-4 p-8 md:py-8 md:px-16">
                <div class="flex flex-col items-end">
                    <h6
                        class="font-black font-mono text-4xl leading-none tracking-tight uppercase"
                    >
                        Summary
                    </h6>
                    <span class="opacity-50">Generated by AI</span>
                </div>
                <div class="border-l-4 border-black pl-4 leading-none">
                    <p class="text-sm md:text-base opacity-90 font-light">
                        {entry.data?.summary || "No summary :("}
                    </p>
                </div>
            </div>
            <div class="border-l-2 border-black p-8 md:py-8 md:px-8 h-full">
                <h6
                    class="font-black font-mono text-4xl tracking-tight uppercase"
                >
                    Tags
                </h6>
                <div class="flex gap-2">
                    {
                        entry.data.tags.map((tag) => (
                            <a
                                href={`/blog?tag=${tag}`}
                                class="relative group bg-white text-black px-3 py-1 text-xs font-bold uppercase tracking-wider"
                            >
                                #{tag}
                                <span class="slide-bg-b bg-white mix-blend-difference" />
                            </a>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
    <!-- Content -->
    <div class="full-width-border">
        <div
            class="content-container grid grid-cols-1 lg:grid-cols-[1fr_4fr] min-h-[calc(100vh-652px)]"
        >
            <!-- 左側：目次 (PCのみ表示) -->
            <aside class="border-r-2 border-black bg-gray-100 hidden lg:block">
                <TableOfContents headings={headings} />
            </aside>
            <div
                class="p-8 md:py-16 md:px-32 prose prose-neutral max-w-none
            prose-headings:font-semibold prose-headings:tracking-tighter prose-headings:text-black
            prose-p:text-black/80 prose-p:font-medium
            prose-h1:text-4xl prose-h2:text-3xl prose-h3:text-2xl prose-h4:text-xl prose-h5:text-lg prose-h6:text-base
            prose-a:text-black prose-a:underline prose-a:decoration-1 prose-a:underline-offset-2 prose-a:transition-colors
            prose-blockquote:border-l-4 prose-blockquote:border-black prose-blockquote:bg-gray-100 prose-blockquote:py-2 prose-blockquote:px-4 prose-blockquote:not-italic
            prose-img:border-2 prose-img:border-black"
            >
                <Content />
            </div>
        </div>
    </div>
    <Section isGrow class="grid grid-cols-[2fr_6fr_2fr]">
        {
            prevPost ? (
                <a
                    href={`/blog/${prevPost.id}`}
                    class="group relative flex flex-col justify-center p-8 border-r-2 border-black "
                >
                    <span class="text-xs font-mono opacity-60 mb-2 group-hover:opacity-100">
                        &lt; NEWER
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight line-clamp-2">
                        {prevPost.data.title}
                    </span>
                    <span class="slide-bg-r bg-white mix-blend-difference" />
                </a>
            ) : (
                <div class="flex flex-col justify-center p-8 border-r-2 border-black select-none">
                    <span class="text-xs font-mono mb-2 opacity-25">
                        &lt; NEWER
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight opacity-25">
                        No newer posts
                    </span>
                </div>
            )
        }
        <div
            class="flex items-center justify-center border-r-2 border-black transition-colors group"
        >
            <a
                href="/blog"
                class="group relative font-black font-mono text-xl md:text-2xl tracking-widest w-full h-full flex items-center justify-center"
            >
                BACK TO BLOG
                <span class="slide-bg-t bg-white mix-blend-difference"></span>
            </a>
        </div>
        {
            nextPost ? (
                <a
                    href={`/blog/${nextPost.id}`}
                    class="group relative flex flex-col justify-center items-end text-right p-8"
                >
                    <span class="text-xs font-mono opacity-60 mb-2 group-hover:opacity-100">
                        OLDER &gt;
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight line-clamp-2">
                        {nextPost.data.title}
                    </span>
                    <span class="slide-bg-l bg-white mix-blend-difference" />
                </a>
            ) : (
                <div class="flex flex-col justify-center items-end text-right p-8 select-none">
                    <span class="text-xs font-mono mb-2 opacity-25">
                        OLDER &gt;
                    </span>
                    <span class="font-bold text-sm md:text-base leading-tight opacity-25">
                        No older posts
                    </span>
                </div>
            )
        }
    </Section>
</Layout>
