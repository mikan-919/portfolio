---
// ... (上のHTML部分は変更なしでOK) ...
interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
const toc = headings.filter((h) => h.depth > 1 && h.depth < 4);
---

<!-- HTML部分はそのまま -->
<nav class="toc-container sticky top-24 self-start hidden lg:block p-8 pr-0">
    <p class="font-black font-mono text-xs mb-4 tracking-widest opacity-50">
        TIMELINE
    </p>

    <ul class="relative border-l-2 border-gray-200 space-y-4">
        <div
            id="toc-indicator"
            class="absolute left-[-2px] top-0 w-[2px] h-0 bg-black transition-all duration-300 ease-out"
        >
        </div>

        {
            toc.map((h) => (
                <li
                    class={`toc-item relative pl-4 ${h.depth === 3 ? "ml-4 text-xs" : "text-sm"}`}
                >
                    <a
                        href={`#${h.slug}`}
                        class="block text-gray-400 hover:text-black transition-colors font-bold leading-tight"
                        data-slug={h.slug}
                    >
                        {h.text}
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<script>
    // 関数として切り出して、再利用可能にする
    const initTOC = () => {
        const observerOptions = {
            root: null,
            rootMargin: "-100px 0px -60% 0px",
            threshold: 0,
        };

        // 監視ロジック
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");
                    if (id) updateActiveLink(id);
                }
            });
        }, observerOptions);

        // 記事内のH2, H3を監視
        // 注意: 記事本文以外のH2などを拾わないよう、.prose クラスなどで範囲を絞るのが推奨です
        document.querySelectorAll(".prose h2, .prose h3").forEach((section) => {
            observer.observe(section);
        });
    };

    // アクティブリンクの更新ロジック
    function updateActiveLink(id: string) {
        // 全てのリンクをリセット
        document.querySelectorAll(".toc-item a").forEach((link) => {
            link.classList.remove("text-black", "scale-105");
            link.classList.add("text-gray-400");
        });

        // アクティブなリンクを黒くする
        const activeLink = document.querySelector(
            `.toc-item a[data-slug="${id}"]`,
        );
        if (activeLink) {
            activeLink.classList.remove("text-gray-400");
            activeLink.classList.add("text-black", "scale-105");

            // 黒いバーの位置を移動
            const indicator = document.getElementById("toc-indicator");
            const listItem = activeLink.closest("li");
            if (indicator && listItem) {
                // 型アサーションやnullチェックを入れて安全に
                if (listItem instanceof HTMLElement) {
                    indicator.style.top = `${listItem.offsetTop}px`;
                    indicator.style.height = `${listItem.offsetHeight}px`;
                }
            }
        }
    }

    // 【重要】astro:page-load イベントで実行する
    // これにより、初回ロード時とViewTransitionによる遷移時の両方で実行されます
    document.addEventListener("astro:page-load", initTOC);
</script>
