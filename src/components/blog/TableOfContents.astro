---
// src/components/blog/TableOfContents.astro
interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

// H2とH3だけ表示する（H1はタイトルなので除外）
const toc = headings.filter((h) => h.depth > 1 && h.depth < 4);
---

<nav class="toc-container sticky top-24 self-start hidden lg:block p-8 pr-0">
    <p class="font-black font-mono text-xs mb-4 tracking-widest opacity-50">
        TIMELINE
    </p>

    <ul class="relative border-l-2 border-gray-200 space-y-4">
        <!-- アクティブな現在地を示す黒いバー（JSで動かす） -->
        <div
            id="toc-indicator"
            class="absolute left-[-2px] top-0 w-[2px] h-0 bg-black transition-all duration-300 ease-out"
        >
        </div>

        {
            toc.map((h) => (
                <li
                    class={`toc-item relative pl-4 ${h.depth === 3 ? "ml-4 text-xs" : "text-sm"}`}
                >
                    <a
                        href={`#${h.slug}`}
                        class="block text-gray-400 hover:text-black transition-colors font-bold leading-tight"
                        data-slug={h.slug}
                    >
                        {h.text}
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<script>
    const observerOptions = {
        root: null,
        // 重要: 判定ラインの調整
        // "-100px": 画面上部から100px下（ヘッダー分）を無視
        // "-60%": 画面の下半分は「まだ読んでない」とみなして無視
        // 結果: 画面の上部30%〜40%くらいのエリアに入った瞬間反応する
        rootMargin: "-100px 0px -60% 0px",
        threshold: 0,
    };
    // スクロール連動ロジック
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                const id = entry.target.getAttribute("id");
                updateActiveLink(id!);
            }
        });
    }, observerOptions); // 画面の中央より少し上に来たら反応

    // 記事内のH2, H3を監視
    document.querySelectorAll("h2, h3").forEach((section) => {
        observer.observe(section);
    });

    function updateActiveLink(id: string) {
        if (!id) return;

        // 全てのリンクをリセット
        document.querySelectorAll(".toc-item a").forEach((link) => {
            link.classList.remove("text-black", "scale-105");
            link.classList.add("text-gray-400");
        });

        // アクティブなリンクを黒くする
        const activeLink = document.querySelector(
            `.toc-item a[data-slug="${id}"]`,
        );
        if (activeLink) {
            activeLink.classList.remove("text-gray-400");
            activeLink.classList.add("text-black", "scale-105");

            // 黒いバーの位置を移動
            const indicator = document.getElementById("toc-indicator");
            const listItem = activeLink.closest("li");
            if (indicator && listItem) {
                indicator.style.top = `${listItem.offsetTop}px`;
                indicator.style.height = `${listItem.offsetHeight}px`;
            }
        }
    }
</script>
